<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>DSS â€” Andaman &amp; Nicobar Ship Boarding System</title>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.19.2/package/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Source+Code+Pro:wght@400;600&display=swap" rel="stylesheet">
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CSS VARIABLES & BASE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root{
  --navy:#060d1b; --deep:#0a1628; --mid:#0e1f3a;
  --teal:#0e7490; --teal-b:#22d3ee; --teal-dim:rgba(14,116,144,.15);
  --amber:#f59e0b; --green:#10b981; --red:#ef4444;
  --muted:#64748b; --text:#cbd5e1; --hi:#f1f5f9;
  --card:rgba(9,19,37,0.94); --bdr:rgba(255,255,255,.07);
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Rajdhani',sans-serif;background:var(--navy);color:var(--text);min-height:100vh;
  background-image:radial-gradient(ellipse at 12% 0%,rgba(14,116,144,.2) 0%,transparent 52%),
  radial-gradient(ellipse at 88% 95%,rgba(99,102,241,.08) 0%,transparent 50%)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEADER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
header{background:linear-gradient(135deg,#0a1628,#0e1f3a);border-bottom:2px solid var(--teal);
  padding:10px 18px;display:flex;align-items:center;justify-content:space-between;
  flex-wrap:wrap;gap:8px;box-shadow:0 4px 28px rgba(0,0,0,.65);position:sticky;top:0;z-index:300}
.hdr-l{display:flex;align-items:center;gap:12px}
.dss-badge{background:linear-gradient(135deg,#0e7490,#0369a1);color:#fff;
  font-size:11px;font-weight:700;letter-spacing:2px;padding:5px 11px;border-radius:5px}
.hdr-title h1{font-size:17px;font-weight:700;color:var(--hi);letter-spacing:.4px}
.hdr-title h1 em{color:var(--teal-b);font-style:normal}
.hdr-meta{font-size:11px;color:var(--muted);font-family:'Source Code Pro',monospace;margin-top:1px}
.hdr-meta b{color:var(--amber)}
.hdr-r{display:flex;gap:6px;align-items:center;flex-wrap:wrap}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BUTTONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.btn{border:none;border-radius:7px;cursor:pointer;font-family:'Rajdhani',sans-serif;
  font-weight:700;font-size:13px;transition:all .16s;
  padding:8px 13px;display:inline-flex;align-items:center;gap:5px;white-space:nowrap}
.btn-teal{background:linear-gradient(135deg,#0e7490,#0369a1);color:#fff}
.btn-teal:hover{background:linear-gradient(135deg,#0891b2,#0284c7);transform:translateY(-1px)}
.btn-teal.rec{background:linear-gradient(135deg,#b91c1c,#dc2626);animation:pulse 1.4s infinite}
@keyframes pulse{0%,100%{box-shadow:0 0 6px rgba(220,38,38,.4)}50%{box-shadow:0 0 18px rgba(220,38,38,.8)}}
.btn-ghost{background:rgba(255,255,255,.06);color:var(--text);border:1px solid var(--bdr)}
.btn-ghost:hover{background:rgba(255,255,255,.12);color:var(--hi)}
.btn-green{background:linear-gradient(135deg,#047857,#10b981);color:#fff}
.btn-green:hover{opacity:.9;transform:translateY(-1px)}
.btn-red{background:linear-gradient(135deg,#991b1b,#ef4444);color:#fff}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SHIP SELECTOR BAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ship-bar{background:var(--mid);border-bottom:1px solid var(--bdr);
  padding:9px 18px;display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.ship-bar-lbl{font-size:10px;color:var(--muted);letter-spacing:1.2px;text-transform:uppercase;white-space:nowrap}
.ship-btn{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.1);
  color:var(--muted);border-radius:7px;padding:7px 14px;cursor:pointer;
  font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:600;transition:all .16s;text-align:center}
.ship-btn:hover{border-color:var(--teal);color:var(--hi)}
.ship-btn.on{background:rgba(14,116,144,.22);border-color:var(--teal-b);color:var(--teal-b)}
.ship-btn small{display:block;font-size:9px;color:var(--muted);font-weight:400;margin-top:1px}
.ship-btn.on small{color:rgba(34,211,238,.55)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN WRAPPER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.main{max-width:1340px;margin:0 auto;padding:14px 16px}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:14px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PANEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.panel{background:var(--card);border:1px solid var(--bdr);border-radius:12px;
  padding:16px;margin-bottom:14px;backdrop-filter:blur(10px)}
.ptitle{font-size:13px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;
  color:var(--teal-b);margin-bottom:12px;padding-bottom:8px;
  border-bottom:1px solid rgba(255,255,255,.05);display:flex;align-items:center;gap:7px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VOYAGE CONFIG
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.v-presets{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
.vbtn{background:rgba(14,116,144,.08);border:1px solid rgba(14,116,144,.28);color:var(--teal-b);
  border-radius:8px;padding:9px 13px;cursor:pointer;font-family:'Rajdhani',sans-serif;
  font-size:12px;font-weight:600;transition:all .16s;text-align:left;min-width:0}
.vbtn b{display:block;font-size:13px}
.vbtn small{display:block;font-size:10px;color:var(--muted);margin-top:2px;line-height:1.4}
.vbtn:hover,.vbtn.on{background:rgba(14,116,144,.28);border-color:var(--teal-b);color:#fff}
.vbtn.on small{color:rgba(255,255,255,.55)}

.rvis{display:flex;align-items:center;flex-wrap:wrap;gap:0;
  background:rgba(0,0,0,.22);border-radius:8px;padding:9px 13px;
  margin-bottom:12px;border:1px solid rgba(14,116,144,.14);min-height:38px}
.rs{display:flex;align-items:center;gap:4px;font-size:11px;font-weight:700}
.rdot{width:9px;height:9px;border-radius:50%;flex-shrink:0}
.rdot.o{background:var(--green)} .rdot.m{background:var(--teal)} .rdot.f{background:var(--amber)}
.rarr{color:rgba(255,255,255,.18);font-size:13px;margin:0 4px}

.cfg-g{display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:10px;margin-bottom:12px}
.cf label{display:block;font-size:10px;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:3px}
.ci{width:100%;background:rgba(0,0,0,.38);border:1px solid rgba(255,255,255,.09);
  color:var(--hi);border-radius:6px;padding:7px 10px;font-family:'Rajdhani',sans-serif;
  font-size:14px;outline:none;transition:border .14s}
.ci:focus{border-color:var(--teal)} .ci[readonly]{opacity:.48;cursor:not-allowed}
option{background:#0a1628}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCANNER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.scan-panel{background:var(--card);border:1px solid var(--teal);border-radius:12px;
  padding:15px;margin-bottom:14px;display:none}
.scan-panel.open{display:block}
.camwrap{position:relative;width:100%;max-width:320px;margin:0 auto;
  border-radius:10px;overflow:hidden;background:#000}
.camwrap video{width:100%;display:block}
.camwrap canvas{display:none}
.scan-guide{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  width:190px;height:190px;border:2px solid rgba(34,211,238,.65);border-radius:8px;
  box-shadow:0 0 0 9999px rgba(0,0,0,.32);pointer-events:none}
.scan-status{text-align:center;font-size:12px;color:var(--muted);margin:7px 0}
.scan-status.ok{color:var(--green)} .scan-status.er{color:var(--red)}
.scan-row{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-top:6px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MANUAL ENTRY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.manual-box{background:rgba(0,0,0,.28);border:1px dashed rgba(255,255,255,.1);
  border-radius:10px;padding:13px;margin-bottom:14px}
.manual-box h4{font-size:11px;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:7px}
.manual-box textarea{width:100%;height:115px;background:rgba(0,0,0,.35);
  border:1px solid rgba(255,255,255,.09);border-radius:7px;color:var(--hi);
  font-family:'Source Code Pro',monospace;font-size:11.5px;padding:9px;
  resize:vertical;outline:none;line-height:1.6}
.manual-box textarea:focus{border-color:var(--teal)}
.mbtn-row{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATS BAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.stats{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:8px;margin-bottom:14px}
.scard{background:var(--card);border:1px solid var(--bdr);border-radius:9px;padding:10px 12px;text-align:center}
.snum{font-family:'Source Code Pro',monospace;font-size:24px;font-weight:700;line-height:1}
.slbl{font-size:10px;color:var(--muted);letter-spacing:.7px;text-transform:uppercase;margin-top:3px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TABS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tabbar{display:flex;border-bottom:2px solid rgba(255,255,255,.06);margin-bottom:13px;overflow-x:auto}
.tab{padding:8px 15px;cursor:pointer;font-weight:600;font-size:13px;color:var(--muted);
  border-bottom:2px solid transparent;margin-bottom:-2px;transition:all .16s;white-space:nowrap}
.tab.on{color:var(--teal-b);border-bottom-color:var(--teal-b)}
.tp{display:none} .tp.on{display:block}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BERTH MAP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.cls-sec{margin-bottom:18px}
.cls-hdr{display:flex;justify-content:space-between;align-items:center;
  padding:8px 12px;border-radius:7px;border-left:3px solid var(--teal);
  margin-bottom:9px}
/* class header colour per class */
.cls-hdr.dulex  {background:rgba(239,68,68,.1);   border-color:#f87171}
.cls-hdr.ordinary{background:rgba(16,185,129,.1); border-color:var(--green)}
.cls-hdr.bunk   {background:rgba(99,102,241,.1);  border-color:#818cf8}
.cls-hdr.special{background:rgba(236,72,153,.1);  border-color:#f472b6}
.cls-hdr.deck   {background:rgba(245,158,11,.1);  border-color:var(--amber)}
.cls-name{font-size:13px;font-weight:700;color:var(--hi)}
.cls-cnt{font-family:'Source Code Pro',monospace;font-size:12px;color:var(--amber)}
.room-blk{margin-bottom:9px}
.room-lbl{font-size:10px;font-weight:600;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:4px}
.seats{display:flex;flex-wrap:wrap;gap:4px}
.seat{min-width:46px;height:34px;border-radius:6px;border:1px solid rgba(255,255,255,.09);
  background:rgba(255,255,255,.03);display:flex;flex-direction:column;
  align-items:center;justify-content:center;cursor:pointer;transition:all .14s;
  font-family:'Source Code Pro',monospace;font-size:10px;font-weight:600;color:var(--muted)}
.seat:hover{border-color:var(--teal);background:var(--teal-dim);color:#fff}
.seat.bkd{background:rgba(16,185,129,.18);border-color:var(--green);color:var(--green)}
.seat.bkd:hover{background:rgba(239,68,68,.14);border-color:var(--red);color:var(--red)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PAX TABLE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.fr{display:flex;gap:8px;align-items:center;margin-bottom:10px;flex-wrap:wrap}
.fr label{font-size:12px;color:var(--muted)}
.fsel,.finp{background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.09);
  color:var(--hi);border-radius:6px;padding:6px 9px;font-family:'Rajdhani',sans-serif;
  font-size:13px;outline:none}
.fsel:focus,.finp:focus{border-color:var(--teal)}
.dtbl{width:100%;border-collapse:collapse;font-size:12.5px}
.dtbl th{background:rgba(14,116,144,.18);color:var(--teal-b);font-weight:700;
  padding:8px;border-bottom:1px solid rgba(14,116,144,.25);text-align:left;white-space:nowrap}
.dtbl td{padding:7px 8px;border-bottom:1px solid rgba(255,255,255,.03);vertical-align:middle}
.dtbl tr:hover td{background:rgba(255,255,255,.02)}
.badge{display:inline-block;padding:2px 7px;border-radius:20px;font-size:10px;font-weight:700}
.badge-bunk{background:rgba(99,102,241,.22);color:#818cf8}
.badge-deck{background:rgba(245,158,11,.18);color:var(--amber)}
.badge-specialDeck{background:rgba(236,72,153,.18);color:#f472b6}
.badge-ordinary{background:rgba(16,185,129,.18);color:var(--green)}
.badge-dulex{background:rgba(239,68,68,.18);color:#f87171}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATION CARDS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(225px,1fr));gap:10px;margin-bottom:14px}
.sc{background:rgba(0,0,0,.28);border:1px solid var(--bdr);border-radius:10px;overflow:hidden}
.sc-hdr{padding:9px 13px;display:flex;justify-content:space-between;align-items:center;font-weight:700;font-size:13px}
.sc-body{padding:0 13px 10px}
.sc-row{display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px solid rgba(255,255,255,.03);font-size:12.5px}
.sc-row:last-child{border:none}
.sc-n{font-family:'Source Code Pro',monospace;font-weight:700}
.sc-tot{font-family:'Source Code Pro',monospace;font-size:22px;font-weight:700}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   REPORT TABLE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.rtbl{width:100%;border-collapse:collapse;font-size:13px}
.rtbl th{color:var(--muted);font-size:10px;letter-spacing:1px;text-transform:uppercase;
  padding:7px 9px;border-bottom:1px solid rgba(255,255,255,.05);text-align:center}
.rtbl td{padding:8px 9px;border-bottom:1px solid rgba(255,255,255,.03);text-align:center}
.rtbl td:first-child{text-align:left;font-weight:600;color:var(--hi)}
.rtbl .trow td{border-top:1px solid var(--teal);color:var(--teal-b);font-weight:700}
.mono{font-family:'Source Code Pro',monospace}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#twrap{position:fixed;top:72px;right:14px;z-index:8000;width:320px;
  display:flex;flex-direction:column;gap:8px;pointer-events:none}
.toast{border-radius:10px;padding:11px 13px;font-size:13px;line-height:1.5;
  box-shadow:0 8px 28px rgba(0,0,0,.6);animation:tsIn .24s ease;
  border-left:4px solid transparent;pointer-events:auto}
.toast.s{background:#022c22;border-color:var(--green)}
.toast.e{background:#3b0000;border-color:var(--red)}
.toast.w{background:#361900;border-color:var(--amber)}
.toast .tt{font-weight:700;font-size:14px;margin-bottom:2px}
.toast.s .tt{color:var(--green)} .toast.e .tt{color:var(--red)} .toast.w .tt{color:var(--amber)}
@keyframes tsIn{from{transform:translateX(110%);opacity:0}to{transform:translateX(0);opacity:1}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ALERT MODAL (hard errors, dismiss only)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);
  z-index:9000;align-items:center;justify-content:center;padding:16px}
.ov.open{display:flex}
.mbox{background:#0a1628;border-radius:14px;padding:26px;max-width:470px;
  width:100%;text-align:center;animation:mpop .22s cubic-bezier(.34,1.56,.64,1)}
@keyframes mpop{from{transform:scale(.72);opacity:0}to{transform:scale(1);opacity:1}}
.mbox.err{border:2px solid var(--red);box-shadow:0 20px 60px rgba(239,68,68,.4)}
.mbox.dup{border:2px solid #f59e0b;box-shadow:0 20px 60px rgba(245,158,11,.35)}
.mic{font-size:50px;margin-bottom:8px}
.mtitle{font-size:20px;font-weight:700;margin-bottom:7px;letter-spacing:1px}
.mbox.err .mtitle{color:var(--red)} .mbox.dup .mtitle{color:var(--amber)}
.mbody{font-size:13px;color:var(--muted);line-height:1.75;margin-bottom:12px}
.mdet{background:rgba(0,0,0,.38);border-radius:7px;padding:11px;text-align:left;
  font-family:'Source Code Pro',monospace;font-size:11px;line-height:2.1;
  margin-bottom:12px;max-height:190px;overflow-y:auto}
.mdet .er{color:var(--red);font-weight:600} .mdet .ok{color:var(--green)}
.mclose{border:none;border-radius:7px;padding:10px 26px;
  font-family:'Rajdhani',sans-serif;font-weight:700;font-size:14px;cursor:pointer}
.mbox.err .mclose{background:var(--red);color:#fff}
.mbox.dup .mclose{background:var(--amber);color:#000}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFIRM MODAL (YES / NO dialogs)
   â€” backdated tickets
   â€” ship/voyage mismatch
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#cov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.82);
  z-index:9500;align-items:center;justify-content:center;padding:16px}
#cov.open{display:flex}
.cbox{background:#0a1628;border-radius:14px;padding:28px;max-width:500px;
  width:100%;text-align:center;animation:mpop .22s cubic-bezier(.34,1.56,.64,1)}
.cbox.bd{border:2px solid var(--red);box-shadow:0 22px 65px rgba(220,38,38,.45)}
.cbox.mm{border:2px solid var(--amber);box-shadow:0 22px 65px rgba(245,158,11,.38)}
.cic{font-size:54px;margin-bottom:8px}
.ctitle{font-size:21px;font-weight:700;margin-bottom:8px;letter-spacing:1px}
.cbox.bd .ctitle{color:var(--red)} .cbox.mm .ctitle{color:var(--amber)}
.cbody{font-size:13.5px;color:var(--muted);line-height:1.8;margin-bottom:12px}
.cdet{background:rgba(0,0,0,.38);border-radius:8px;padding:12px;text-align:left;
  font-family:'Source Code Pro',monospace;font-size:11.5px;line-height:2.1;
  margin-bottom:18px;max-height:200px;overflow-y:auto}
.cdet .er{color:var(--red);font-weight:700} .cdet .wa{color:var(--amber);font-weight:700}
.cdet .ok{color:var(--green)}
.cbtns{display:flex;gap:12px;justify-content:center;flex-wrap:wrap}
.cbtn-yes{background:linear-gradient(135deg,#047857,#10b981);color:#fff;border:none;
  border-radius:9px;padding:12px 34px;font-family:'Rajdhani',sans-serif;
  font-weight:700;font-size:16px;cursor:pointer;transition:opacity .15s;letter-spacing:.4px}
.cbtn-yes:hover{opacity:.88}
.cbtn-no{background:rgba(239,68,68,.16);color:var(--red);border:1.5px solid rgba(239,68,68,.35);
  border-radius:9px;padding:12px 34px;font-family:'Rajdhani',sans-serif;
  font-weight:700;font-size:16px;cursor:pointer;transition:all .15s;letter-spacing:.4px}
.cbtn-no:hover{background:rgba(239,68,68,.28)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FOOTER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
footer{background:linear-gradient(135deg,#050c18,#0a1628);
  border-top:1px solid rgba(14,116,144,.22);padding:14px 20px;text-align:center;margin-top:4px}
.foot-dev{font-size:13px;color:var(--muted)}
.foot-dev strong{color:var(--teal-b)}
.foot-copy{font-size:11px;color:rgba(100,116,139,.55);margin-top:5px;letter-spacing:.3px}

@media(max-width:680px){
  header,.ship-bar{flex-direction:column;text-align:center}
  .hdr-r{justify-content:center}
  .g2{grid-template-columns:1fr}
  .seat{min-width:40px;height:30px;font-size:9px}
}
</style>
</head>
<body>

<!-- â•â• ALERT MODAL (hard errors) â•â• -->
<div class="ov" id="aov">
  <div class="mbox err" id="abox">
    <div class="mic" id="amic">â›”</div>
    <div class="mtitle" id="atitle"></div>
    <div class="mbody" id="abody"></div>
    <div class="mdet" id="adet"></div>
    <button class="mclose" onclick="closeAlert()">DISMISS</button>
  </div>
</div>

<!-- â•â• CONFIRM MODAL (YES / NO) â•â• -->
<div id="cov">
  <div class="cbox" id="cbox">
    <div class="cic" id="cic">âš ï¸</div>
    <div class="ctitle" id="ctitle"></div>
    <div class="cbody" id="cbody"></div>
    <div class="cdet" id="cdet"></div>
    <div class="cbtns">
      <button class="cbtn-yes" onclick="doYes()">âœ… YES â€” BOARD PASSENGER</button>
      <button class="cbtn-no"  onclick="doNo()">âŒ NO â€” REJECT TICKET</button>
    </div>
  </div>
</div>

<div id="twrap"></div>

<!-- â•â• HEADER â•â• -->
<header>
  <div class="hdr-l">
    <span class="dss-badge">ğŸš¢ DSS</span>
    <div class="hdr-title">
      <h1>Andaman &amp; Nicobar &nbsp;<em id="hdr-vessel">â€” Ship Boarding System</em></h1>
      <div class="hdr-meta">
        Voyage <b id="hdr-voy">â€”</b> &nbsp;|&nbsp;
        <b id="hdr-route">Select ship &amp; configure voyage</b> &nbsp;|&nbsp;
        Sail: <b id="hdr-date">â€”</b>
      </div>
    </div>
  </div>
  <div class="hdr-r">
    <button class="btn btn-teal" id="btnscan" onclick="toggleScan()">ğŸ“· Scan QR</button>
    <button class="btn btn-ghost" onclick="expPDF_full()">ğŸ“„ Full PDF</button>
    <button class="btn btn-ghost" onclick="expPDF_stn()">ğŸ“ Station PDF</button>
    <button class="btn btn-ghost" onclick="expExcel()">ğŸ“¥ Excel</button>
  </div>
</header>

<!-- â•â• SHIP SELECTOR â•â• -->
<div class="ship-bar">
  <span class="ship-bar-lbl">ğŸš¢ Select Ship:</span>
  <button class="ship-btn" id="sb-KALIGHAT" onclick="pickShip('KALIGHAT')">
    M.V KALIGHAT<small>Andaman &amp; Nicobar</small></button>
  <button class="ship-btn" id="sb-SENTINEL" onclick="pickShip('SENTINEL')">
    M.V SENTINEL<small>Andaman &amp; Nicobar</small></button>
  <button class="ship-btn" id="sb-NALANDA"  onclick="pickShip('NALANDA')">
    M.V NALANDA<small>Andaman &amp; Nicobar</small></button>
  <button class="ship-btn" id="sb-SINDU"    onclick="pickShip('SINDU')">
    M.V SINDU<small>Andaman &amp; Nicobar</small></button>
</div>

<div class="main">

<!-- â•â• VOYAGE CONFIG â•â• -->
<div class="panel">
  <div class="ptitle">âš™ï¸ Voyage Configuration
    <span id="ship-badge" style="background:rgba(14,116,144,.3);border:1px solid var(--teal);
      color:var(--teal-b);font-size:10px;padding:2px 9px;border-radius:4px;
      font-weight:700;letter-spacing:1px;margin-left:8px">NO SHIP SELECTED</span>
  </div>

  <div style="background:rgba(245,158,11,.07);border:1px solid rgba(245,158,11,.2);
    border-radius:8px;padding:10px 14px;margin-bottom:13px;font-size:13px;line-height:1.6">
    âš“ <strong style="color:var(--amber)">Boarding Port is fixed: CAR NICOBAR</strong> â€”
    Select a voyage type, enter voyage number &amp; sailing date, then click
    <strong>Save &amp; Activate</strong>. Backdated or mismatched tickets will trigger confirmation.
  </div>

  <div style="margin-bottom:12px;display:flex;gap:10px;align-items:center;flex-wrap:wrap">
    <span style="font-size:13px;color:var(--muted)">Active ship:</span>
    <span id="ship-name-disp" style="font-size:16px;font-weight:700;color:var(--teal-b)">
      None â€” click a ship above first</span>
  </div>

  <!-- Voyage presets -->
  <div class="v-presets">
    <button class="vbtn" id="vp1" onclick="setPreset(1)">
      <b>ğŸ”µ Type 1 â€” Direct</b>
      <small>Car Nicobar â†’ Sri Vijaya Puram</small></button>
    <button class="vbtn" id="vp2" onclick="setPreset(2)">
      <b>ğŸŸ¢ Type 2 â€” Via Little Andaman</b>
      <small>Car Nicobar â†’ Little Andaman â†’ Sri Vijaya Puram</small></button>
    <button class="vbtn" id="vp3" onclick="setPreset(3)">
      <b>ğŸŸ  Type 3 â€” Nancowry Route</b>
      <small>Car Nicobar â†’ Chowra â†’ Teressa â†’ Katchal â†’ Nancowry</small></button>
    <button class="vbtn" id="vp4" onclick="setPreset(4)">
      <b>ğŸ”´ Type 4 â€” Campbell Bay (Full)</b>
      <small>Car Nicobar â†’ Chowra â†’ Teressa â†’ Katchal â†’ Nancowry â†’ Campbell Bay</small></button>
  </div>

  <!-- Route visualiser -->
  <div class="rvis" id="rvis"><span style="font-size:12px;color:var(--muted)">â† Select a voyage type to see route</span></div>

  <!-- Fields -->
  <div class="cfg-g">
    <div class="cf"><label>Ship Name</label>
      <input class="ci" id="cfg-vessel" placeholder="Select ship above" value=""></div>
    <div class="cf"><label>Voyage No.</label>
      <input class="ci" id="cfg-voyage" placeholder="e.g. 2239" value=""></div>
    <div class="cf"><label>Boarding Port (Fixed)</label>
      <input class="ci" id="cfg-board" value="CAR NICOBAR" readonly></div>
    <div class="cf"><label>Final Deboarding</label>
      <input class="ci" id="cfg-deboard" placeholder="Auto-filled by preset" value=""></div>
    <div class="cf"><label>Sailing Date</label>
      <input class="ci" id="cfg-date" placeholder="26-Feb-2026" value=""></div>
    <div class="cf"><label>Sailing Time</label>
      <input class="ci" id="cfg-time" value="07:00"></div>
  </div>
  <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
    <button class="btn btn-green" onclick="saveCfg()">ğŸ’¾ Save &amp; Activate Voyage</button>
    <div id="cfg-ok" style="font-size:13px;color:var(--muted)"></div>
  </div>
</div>

<!-- â•â• QR SCANNER â•â• -->
<div class="scan-panel" id="scanpanel">
  <div class="ptitle">ğŸ“· QR Ticket Scanner</div>
  <div class="camwrap">
    <video id="camvid" autoplay playsinline muted></video>
    <canvas id="camcvs"></canvas>
    <div class="scan-guide"></div>
  </div>
  <div class="scan-status" id="scanst">Starting cameraâ€¦</div>
  <div class="scan-row">
    <button class="btn btn-teal rec" onclick="stopScan()">â¹ Stop Scanner</button>
    <button class="btn btn-ghost" onclick="flipCam()">ğŸ”„ Switch Camera</button>
  </div>
</div>

<!-- â•â• MANUAL ENTRY (always visible) â•â• -->
<div class="manual-box">
  <h4>âœï¸ Manual Ticket Entry â€” paste full ticket text here (supports 1â€“5 passengers)</h4>
  <textarea id="manual-inp" placeholder="PNR: 2951490078,
Txn ID: 2602014809,
Vessel: MV KALIGHAT,
Voyage: 2239,
Boarding: SRI VIJAYA PURAM,
Deboarding: CAR NICOBAR,
Sailing Date&Time: 26-Feb-2026 07:00,
Class: BUNK,
Passenger 1: 
	KAJOL ROY
	F/33
	DECK-2 , ROOM-1 , BERTH-108 (U)"></textarea>
  <div class="mbtn-row">
    <button class="btn btn-green" onclick="procManual()">âœ… Process Ticket</button>
    <button class="btn btn-ghost" onclick="document.getElementById('manual-inp').value=''">ğŸ—‘ Clear</button>
  </div>
</div>

<!-- â•â• STATS BAR â•â• -->
<div class="stats">
  <div class="scard" style="border-color:rgba(34,211,238,.2)">
    <div class="snum" id="st0" style="color:var(--teal-b)">0</div>
    <div class="slbl">Total</div>
  </div>
  <div class="scard"><div class="snum" id="st-dulex"      style="color:#f87171">0</div><div class="slbl">Deluxe</div></div>
  <div class="scard"><div class="snum" id="st-ordinary"   style="color:var(--green)">0</div><div class="slbl">Ordinary</div></div>
  <div class="scard"><div class="snum" id="st-bunk"       style="color:#818cf8">0</div><div class="slbl">Bunk</div></div>
  <div class="scard"><div class="snum" id="st-specialDeck" style="color:#f472b6">0</div><div class="slbl">Spl.Deck</div></div>
  <div class="scard"><div class="snum" id="st-deck"       style="color:var(--amber)">0</div><div class="slbl">Deck</div></div>
</div>

<!-- â•â• MAIN TABS â•â• -->
<div class="panel" style="padding-bottom:6px">
  <div class="tabbar">
    <div class="tab on" onclick="goTab('berth')">ğŸ›ï¸ Berth Map</div>
    <div class="tab" onclick="goTab('pax')">ğŸ§¾ All Passengers</div>
    <div class="tab" onclick="goTab('stn')">ğŸ“ Station-wise</div>
    <div class="tab" onclick="goTab('rpt')">ğŸ“Š Live Report</div>
  </div>

  <!-- â”€â”€ BERTH MAP (order: Deluxe â†’ Ordinary â†’ Bunk â†’ Special Deck â†’ Deck) â”€â”€ -->
  <div class="tp on" id="tp-berth">
    <div class="cls-sec">
      <div class="cls-hdr dulex">
        <span class="cls-name">1ï¸âƒ£ &nbsp;DELUXE CABIN</span>
        <span class="cls-cnt" id="cnt-dulex">0 boarded</span>
      </div>
      <div id="rm-dulex"></div>
    </div>
    <div class="cls-sec">
      <div class="cls-hdr ordinary">
        <span class="cls-name">2ï¸âƒ£ &nbsp;ORDINARY CABIN</span>
        <span class="cls-cnt" id="cnt-ordinary">0 boarded</span>
      </div>
      <div id="rm-ordinary"></div>
    </div>
    <div class="cls-sec">
      <div class="cls-hdr bunk">
        <span class="cls-name">3ï¸âƒ£ &nbsp;BUNK CLASS</span>
        <span class="cls-cnt" id="cnt-bunk">0 boarded</span>
      </div>
      <div id="rm-bunk"></div>
    </div>
    <div class="cls-sec">
      <div class="cls-hdr special">
        <span class="cls-name">4ï¸âƒ£ &nbsp;SPECIAL DECK</span>
        <span class="cls-cnt" id="cnt-specialDeck">0 boarded</span>
      </div>
      <div id="rm-specialDeck"></div>
    </div>
    <div class="cls-sec">
      <div class="cls-hdr deck">
        <span class="cls-name">5ï¸âƒ£ &nbsp;DECK</span>
        <span class="cls-cnt" id="cnt-deck">0 boarded</span>
      </div>
      <div id="rm-deck"></div>
    </div>
    <p style="font-size:11px;color:var(--muted);padding:3px 0 6px">
      Berths appear dynamically as tickets are scanned. Click a green berth to remove that passenger.</p>
  </div>

  <!-- â”€â”€ ALL PASSENGERS â”€â”€ -->
  <div class="tp" id="tp-pax">
    <div class="fr">
      <label>Class:
        <select class="fsel" id="fcls" onchange="renderTbl()">
          <option value="all">All</option>
          <option value="dulex">Deluxe</option>
          <option value="ordinary">Ordinary</option>
          <option value="bunk">Bunk</option>
          <option value="specialDeck">Special Deck</option>
          <option value="deck">Deck</option>
        </select>
      </label>
      <label>Deboarding:
        <select class="fsel" id="fdeb" onchange="renderTbl()">
          <option value="all">All Ports</option>
        </select>
      </label>
      <input class="finp" id="fsrch" oninput="renderTbl()" placeholder="ğŸ” Name / PNRâ€¦" style="width:155px">
    </div>
    <div style="overflow-x:auto">
      <table class="dtbl">
        <thead><tr>
          <th>#</th><th>PNR</th><th>Name</th><th>Age/Sex</th><th>Class</th>
          <th>Deck</th><th>Room</th><th>Berth</th><th>Type</th><th>Deboarding</th><th></th>
        </tr></thead>
        <tbody id="pax-body"></tbody>
      </table>
    </div>
    <div id="pax-empty" style="text-align:center;padding:26px;color:var(--muted);font-size:13px;display:none">
      No passengers boarded yet</div>
  </div>

  <!-- â”€â”€ STATION-WISE â”€â”€ -->
  <div class="tp" id="tp-stn">
    <p style="font-size:13px;color:var(--muted);margin-bottom:12px">
      Live count per deboarding station, ordered by route sequence. Updates on every scan.</p>
    <div id="stn-cards"></div>
    <div style="overflow-x:auto;margin-top:13px">
      <table class="dtbl" id="stn-tbl" style="display:none">
        <thead><tr>
          <th>Station</th><th>#</th><th>PNR</th><th>Name</th><th>Age/Sex</th>
          <th>Class</th><th>Dk</th><th>Rm</th><th>Berth</th>
        </tr></thead>
        <tbody id="stn-body"></tbody>
      </table>
    </div>
  </div>

  <!-- â”€â”€ LIVE REPORT â”€â”€ -->
  <div class="tp" id="tp-rpt">
    <div class="g2" style="margin-bottom:14px">
      <div>
        <h4 style="font-size:11px;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:9px">CLASS-WISE</h4>
        <table class="rtbl"><thead><tr><th>Class</th><th>Boarded</th><th>Berths</th><th>Remaining</th></tr></thead>
        <tbody id="rpt-cls"></tbody></table>
      </div>
      <div>
        <h4 style="font-size:11px;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:9px">STATION-WISE</h4>
        <table class="rtbl"><thead><tr><th>Deboarding Station</th><th>Pax</th><th>%</th></tr></thead>
        <tbody id="rpt-stn"></tbody></table>
      </div>
    </div>
    <h4 style="font-size:11px;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:9px">CLASS Ã— STATION MATRIX</h4>
    <div style="overflow-x:auto"><table class="rtbl" id="rpt-mat"></table></div>
  </div>
</div><!-- /panel -->
</div><!-- /main -->

<!-- â•â• FOOTER â•â• -->
<footer>
  <div class="foot-dev">
    Developed by <strong>Mahesh Surada</strong> &nbsp;|&nbsp;
    DSS Staff â€” Directorate of Shipping Services &nbsp;|&nbsp;
    Andaman &amp; Nicobar Administration
  </div>
  <div class="foot-copy">
    Â© 2025 Mahesh Surada. All Rights Reserved. Unauthorised reproduction or redistribution is strictly prohibited.
  </div>
</footer>

<script>
'use strict';

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SHIPS & VOYAGE PRESETS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const SHIPS = {
  KALIGHAT:{ full:'MV KALIGHAT', disp:'M.V KALIGHAT' },
  SENTINEL:{ full:'MV SENTINEL', disp:'M.V SENTINEL' },
  NALANDA: { full:'MV NALANDA',  disp:'M.V NALANDA'  },
  SINDU:   { full:'MV SINDU',    disp:'M.V SINDU'    }
};

const PRESETS = {
  1:{ name:'Type 1 â€” Direct',
      stops:['CAR NICOBAR','SRI VIJAYA PURAM'],
      deboard:'SRI VIJAYA PURAM',
      valid:['SRI VIJAYA PURAM'] },
  2:{ name:'Type 2 â€” Via Little Andaman',
      stops:['CAR NICOBAR','LITTLE ANDAMAN','SRI VIJAYA PURAM'],
      deboard:'SRI VIJAYA PURAM',
      valid:['LITTLE ANDAMAN','SRI VIJAYA PURAM'] },
  3:{ name:'Type 3 â€” Nancowry',
      stops:['CAR NICOBAR','CHOWRA','TERESSA','KATCHAL','NANCOWRY'],
      deboard:'NANCOWRY',
      valid:['CHOWRA','TERESSA','KATCHAL','NANCOWRY'] },
  4:{ name:'Type 4 â€” Campbell Bay',
      stops:['CAR NICOBAR','CHOWRA','TERESSA','KATCHAL','NANCOWRY','CAMPBELL BAY'],
      deboard:'CAMPBELL BAY',
      valid:['CHOWRA','TERESSA','KATCHAL','NANCOWRY','CAMPBELL BAY'] }
};

let activeShip = null, activePreset = null;

function pickShip(key) {
  activeShip = key;
  document.querySelectorAll('.ship-btn').forEach(b=>b.classList.remove('on'));
  document.getElementById('sb-'+key).classList.add('on');
  const s = SHIPS[key];
  document.getElementById('ship-name-disp').textContent = s.disp;
  document.getElementById('ship-badge').textContent = s.disp;
  document.getElementById('cfg-vessel').value = s.full;
  toast('s','ğŸš¢ Ship Selected', s.disp + ' is now active');
}

function setPreset(n) {
  activePreset = n;
  document.querySelectorAll('.vbtn').forEach(b=>b.classList.remove('on'));
  document.getElementById('vp'+n).classList.add('on');
  document.getElementById('cfg-deboard').value = PRESETS[n].deboard;
  drawRoute(PRESETS[n].stops);
}

function drawRoute(stops) {
  const el = document.getElementById('rvis'); el.innerHTML = '';
  stops.forEach((s,i)=>{
    const w=document.createElement('span'); w.className='rs';
    const d=document.createElement('span');
    d.className='rdot '+(i===0?'o':i===stops.length-1?'f':'m');
    const l=document.createElement('span');
    l.textContent=s;
    l.style.cssText=`color:${i===0?'var(--green)':i===stops.length-1?'var(--amber)':'var(--hi)'}`;
    w.appendChild(d); w.appendChild(l); el.appendChild(w);
    if(i<stops.length-1){const a=document.createElement('span');a.className='rarr';a.textContent='â†’';el.appendChild(a);}
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VOYAGE CONFIG STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let cfg = { vessel:'',voyage:'',boarding:'CAR NICOBAR',deboard:'',date:'',time:'07:00',valid:[] };

function saveCfg() {
  if (!activeShip)   { toast('w','âš ï¸ No Ship','Please select a ship first'); return; }
  if (!activePreset) { toast('w','âš ï¸ No Preset','Please select a voyage type first'); return; }
  if (!document.getElementById('cfg-voyage').value.trim()) { toast('w','âš ï¸ Missing','Enter voyage number'); return; }
  if (!document.getElementById('cfg-date').value.trim())   { toast('w','âš ï¸ Missing','Enter sailing date'); return; }
  cfg = {
    vessel:  document.getElementById('cfg-vessel').value.trim().toUpperCase(),
    voyage:  document.getElementById('cfg-voyage').value.trim(),
    boarding:'CAR NICOBAR',
    deboard: document.getElementById('cfg-deboard').value.trim().toUpperCase(),
    date:    document.getElementById('cfg-date').value.trim(),
    time:    document.getElementById('cfg-time').value.trim(),
    valid:   PRESETS[activePreset].valid
  };
  updHdr(); buildDebFilter();
  document.getElementById('cfg-ok').innerHTML =
    `<span style="color:var(--green)">âœ… Active â€” ${cfg.vessel} | Voyage ${cfg.voyage} | ${PRESETS[activePreset].name}</span>`;
  toast('s','âš™ï¸ Voyage Activated',`${cfg.vessel}\n${cfg.boarding} â†’ ${cfg.deboard} | ${cfg.date} ${cfg.time}`);
  renderAll();
}

function updHdr() {
  document.getElementById('hdr-vessel').textContent = cfg.vessel ? 'â€” '+cfg.vessel : 'â€” Ship Boarding System';
  document.getElementById('hdr-voy').textContent  = cfg.voyage  || 'â€”';
  document.getElementById('hdr-route').textContent= cfg.boarding&&cfg.deboard ? cfg.boarding+' â†’ '+cfg.deboard : 'Configure voyage below';
  document.getElementById('hdr-date').textContent = cfg.date || 'â€”';
}

function buildDebFilter() {
  const sel=document.getElementById('fdeb');
  sel.innerHTML='<option value="all">All Ports</option>';
  (cfg.valid||[]).forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; sel.appendChild(o); });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DATA STORE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const berthMap={}, PAX=[], donePNR=new Set();
const LAY={ dulex:[], ordinary:[], bunk:[], specialDeck:[], deck:[] };
const CLS_LBL={ dulex:'Deluxe', ordinary:'Ordinary', bunk:'Bunk', specialDeck:'Spl.Deck', deck:'Deck' };
const CLS_CLR={ dulex:'#f87171', ordinary:'var(--green)', bunk:'#818cf8', specialDeck:'#f472b6', deck:'var(--amber)' };
// PDF class order: Deluxe first
const CLS_ORDER = ['dulex','ordinary','bunk','specialDeck','deck'];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HELPER: normalise string
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function N(s){ return (s||'').toString().trim().toUpperCase().replace(/\s+/g,' '); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DATE HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function parseTicketDate(str) {
  if (!str) return null;
  str = str.trim();
  const MON = {jan:0,feb:1,mar:2,apr:3,may:4,jun:5,jul:6,aug:7,sep:8,oct:9,nov:10,dec:11};
  // DD-Mon-YYYY  e.g. 26-Feb-2026
  let m = str.match(/^(\d{1,2})[\/\-]([A-Za-z]+)[\/\-](\d{4})$/);
  if (m) { const mo=MON[m[2].toLowerCase().slice(0,3)]; return mo!=null ? new Date(+m[3],mo,+m[1]) : null; }
  // DD-MM-YYYY
  m = str.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
  if (m) return new Date(+m[3],+m[2]-1,+m[1]);
  // YYYY-MM-DD
  m = str.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/);
  if (m) return new Date(+m[1],+m[2]-1,+m[3]);
  return null;
}

function isBackdated(dateStr) {
  const d = parseTicketDate(dateStr);
  if (!d || isNaN(d)) return false;
  const today = new Date(); today.setHours(0,0,0,0);
  return d < today;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TICKET PARSER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function parseTicket(raw) {
  const lines = raw.split('\n').map(l=>l.trim()).filter(Boolean);
  const get = k => {
    const l = lines.find(x=>x.toLowerCase().startsWith(k.toLowerCase()));
    return l ? l.slice(l.indexOf(':')+1).trim().replace(/,$/,'').trim() : null;
  };
  const sailing = get('Sailing Date');
  let sailDate = null;
  if (sailing) sailDate = sailing.split(' ')[0].trim();

  const pax = [];
  let i = 0;
  while (i < lines.length) {
    if (/^passenger\s+\d+\s*:/i.test(lines[i])) {
      const name = lines[i+1]||'', ageSex = lines[i+2]||'', bRaw = lines[i+3]||'';
      let dk=null,rm=null,bn=null,bt=null;
      const bm = bRaw.match(/DECK[- ](\w+)\s*,\s*ROOM[- ](\w+)\s*,\s*BERTH[- ](\d+)\s*(?:\((\w+)\))?/i);
      if (bm) { dk=bm[1]; rm=bm[2]; bn=bm[3]; bt=bm[4]||''; }
      else { const bx=bRaw.match(/BERTH[- ](\d+)/i); if(bx) bn=bx[1]; }
      if (name.trim()) pax.push({name:name.trim(),ageSex:ageSex.trim(),bRaw:bRaw.trim(),dk,rm,bn,bt});
      i+=4;
    } else i++;
  }
  return {
    pnr:get('PNR'), txn:get('Txn ID'), vessel:get('Vessel'), voyage:get('Voyage'),
    boarding:get('Boarding'), deboarding:get('Deboarding'), sailDate,
    cls:get('Class'), passengers:pax
  };
}

function mapCls(raw) {
  if (!raw) return 'deck';
  const v = raw.toUpperCase();
  if (v.includes('BUNK'))                          return 'bunk';
  if (v.includes('DULEX')||v.includes('DELUX'))    return 'dulex';
  if (v.includes('SPECIAL'))                       return 'specialDeck';
  if (v.includes('ORDINARY')||v.includes('CABIN')) return 'ordinary';
  return 'deck';
}

function mkKey(c,d,r,b){ return `${c}|${d||'0'}|${r||'0'}|${b||'?'}`; }
function ensureLayout(c,d,r,b){
  if(!LAY[c]) LAY[c]=[];
  if(!LAY[c].find(x=>x.d===d&&x.r===r&&x.b===b)) LAY[c].push({d:d||'0',r:r||'0',b:b||'?'});
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFIRM MODAL â€” YES / NO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _pending = null; // ticket payload waiting for user decision

function showConfirm(type, icon, title, bodyTxt, detHTML, payload) {
  _pending = payload;
  document.getElementById('cic').textContent    = icon;
  document.getElementById('ctitle').textContent = title;
  document.getElementById('cbody').textContent  = bodyTxt;
  document.getElementById('cdet').innerHTML     = detHTML.replace(/\n/g,'<br>');
  document.getElementById('cbox').className     = 'cbox ' + type;
  document.getElementById('cov').classList.add('open');
}

function doYes() {
  document.getElementById('cov').classList.remove('open');
  if (_pending) { boardIt(_pending); _pending = null; }
}

function doNo() {
  document.getElementById('cov').classList.remove('open');
  _pending = null;
  toast('w','ğŸš« Ticket Rejected','Passenger was NOT added to boarding list.');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ALERT MODAL â€” dismiss only
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showAlert(type, icon, title, bodyTxt, detHTML) {
  document.getElementById('amic').textContent   = icon;
  document.getElementById('atitle').textContent = title;
  document.getElementById('abody').textContent  = bodyTxt;
  document.getElementById('adet').innerHTML     = (detHTML||'').replace(/\n/g,'<br>');
  document.getElementById('abox').className     = 'mbox '+ type;
  document.getElementById('aov').classList.add('open');
}
function closeAlert(){ document.getElementById('aov').classList.remove('open'); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROCESS TICKET  â† main entry point
   Order of checks:
   1) Parse failure
   2) Duplicate PNR
   3) Backdated sailing date  â†’ YES / NO
   4) Ship name OR voyage no mismatch â†’ YES / NO
   5) Deboarding port not in route    â†’ hard DENY
   6) All OK â†’ board
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function processTicket(raw) {
  if (!raw||!raw.trim()) { toast('e','Empty','No ticket data'); return; }

  let t;
  try { t = parseTicket(raw); } catch(e) { toast('e','Parse Error',e.message); return; }

  if (!t.pnr && !t.vessel) {
    showAlert('err','âŒ','UNREADABLE TICKET',
      'Could not read ticket data. Please verify the ticket format.',''); return;
  }

  // â”€â”€ 1. DUPLICATE â”€â”€
  if (t.pnr && donePNR.has(t.pnr)) {
    showAlert('dup','ğŸ”','DUPLICATE TICKET',
      'This ticket (PNR '+t.pnr+') has already been processed and boarded.',
      `<span class="er">PNR ${t.pnr} was already checked in. Boarding not allowed again.</span>`);
    return;
  }

  if (!t.passengers||!t.passengers.length) {
    showAlert('err','âŒ','NO PASSENGER DATA','No passenger information found in this ticket.',''); return;
  }

  const payload = { t };

  // â”€â”€ 2. BACKDATED CHECK â”€â”€
  if (t.sailDate && isBackdated(t.sailDate)) {
    const today = new Date();
    const det =
      `<span class="er">ğŸ“…  Ticket Sail Date : ${t.sailDate}\n` +
      `   Today's Date     : ${today.toDateString()}\n\n` +
      `âš   This ticket's sailing date has ALREADY PASSED.\n` +
      `   This may be an expired / back-dated ticket.</span>`;
    showConfirm('bd','ğŸ“…',
      'BACK-DATED TICKET DETECTED',
      `Sailing date on ticket is ${t.sailDate}, which is in the past.\n` +
      `Do you still want to board this passenger?`,
      det, payload);
    return; // wait for user choice
  }

  // â”€â”€ 3. SHIP NAME OR VOYAGE NUMBER MISMATCH â”€â”€
  const softMis = [];
  if (cfg.vessel) {
    if (N(t.vessel) && N(t.vessel) !== N(cfg.vessel))
      softMis.push({ l:'Ship / Vessel Name', tv:N(t.vessel),   cv:N(cfg.vessel)  });
    if (N(t.voyage) && N(t.voyage) !== N(cfg.voyage))
      softMis.push({ l:'Voyage Number',      tv:N(t.voyage),   cv:N(cfg.voyage)  });
    if (N(t.boarding) && N(t.boarding) !== N(cfg.boarding))
      softMis.push({ l:'Boarding Port',      tv:N(t.boarding), cv:N(cfg.boarding)});
    if (N(t.sailDate) && N(t.sailDate) !== N(cfg.date))
      softMis.push({ l:'Sailing Date',       tv:N(t.sailDate), cv:N(cfg.date)    });
  }
  if (softMis.length) {
    let det = '';
    softMis.forEach(m => {
      det += `<span class="wa">âš   ${m.l}:\n   TICKET   = "${m.tv}"\n   EXPECTED = "${m.cv}"</span>\n`;
    });
    showConfirm('mm','âš ï¸',
      'TICKET MISMATCH',
      'The ticket details do not match the configured voyage.\n' +
      'Do you still want to board this passenger?',
      det, payload);
    return; // wait for user choice
  }

  // â”€â”€ 4. DEBOARDING PORT NOT IN ROUTE â€” hard deny â”€â”€
  const td = N(t.deboarding);
  if (td && cfg.valid && cfg.valid.length && !cfg.valid.includes(td)) {
    showAlert('err','â›”','INVALID DEBOARDING PORT â€” BOARDING DENIED',
      'The deboarding port on this ticket is not a valid stop on the configured route.',
      `<span class="er">âœ—  Deboarding Port:\n   TICKET   = "${td}"\n   VALID    = "${cfg.valid.join(', ')}"</span>`);
    return;
  }

  // â”€â”€ 5. ALL GOOD â”€â”€
  boardIt(payload);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOARD PASSENGERS (commit to system)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function boardIt(payload) {
  const t   = payload.t;
  const cls = mapCls(t.cls);
  const ok  = [], fail = [];

  t.passengers.forEach(p => {
    const key = mkKey(cls,p.dk,p.rm,p.bn);
    if (berthMap[key]) { fail.push({p,reason:'Berth already occupied by another passenger'}); return; }
    const obj = {
      pnr:t.pnr, txn:t.txn, name:p.name, ageSex:p.ageSex,
      classCode:cls, classLabel:t.cls||cls,
      dk:p.dk, rm:p.rm, bn:p.bn, bt:p.bt,
      boarding:t.boarding||cfg.boarding,
      deboarding:N(t.deboarding),
      sailDate:t.sailDate, key
    };
    berthMap[key]=obj; PAX.push(obj);
    ensureLayout(cls,p.dk,p.rm,p.bn);
    ok.push(obj);
  });

  if (t.pnr) donePNR.add(t.pnr);
  renderAll();
  addDebOpt(t.deboarding);

  if (fail.length && ok.length) {
    let det = ok.map(a=>`<span class="ok">âœ“ ${a.name} â†’ BERTH-${a.bn}</span>`).join('\n')+'\n'+
              fail.map(f=>`<span class="er">âœ— ${f.p.name} â€” BERTH-${f.p.bn}: ${f.reason}</span>`).join('\n');
    showAlert('dup','âš ï¸','PARTIAL BOARDING',`${ok.length} boarded, ${fail.length} failed.`,det);
  } else if (fail.length && !ok.length) {
    let det = fail.map(f=>`<span class="er">âœ— ${f.p.name}: ${f.reason}</span>`).join('\n');
    showAlert('err','âŒ','BOARDING FAILED','All berths were already occupied.',det);
  } else {
    toast('s',`âœ… ${ok.length} Passenger${ok.length>1?'s':''} Boarded`,
      ok.map(a=>`${a.name} â†’ D${a.dk}-R${a.rm}-BERTH ${a.bn}`).join('\n'));
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER EVERYTHING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderAll() {
  renderBerthMap(); renderTbl(); renderStn(); renderRpt(); updStats();
}

/* â”€â”€ BERTH MAP â”€â”€ */
function renderBerthMap() {
  const SECS = { dulex:'rm-dulex', ordinary:'rm-ordinary', bunk:'rm-bunk', specialDeck:'rm-specialDeck', deck:'rm-deck' };
  Object.entries(SECS).forEach(([cls,eid])=>{
    const el=document.getElementById(eid); if(!el) return;
    el.innerHTML='';
    const berths=LAY[cls]||[];
    if(!berths.length){
      el.innerHTML='<div style="font-size:12px;color:var(--muted);padding:5px 0">No berths yet â€” scan tickets</div>';
      const c=document.getElementById('cnt-'+cls); if(c) c.textContent='0 boarded'; return;
    }
    const byDk={};
    berths.forEach(b=>{ if(!byDk[b.d])byDk[b.d]={}; if(!byDk[b.d][b.r])byDk[b.d][b.r]=[]; byDk[b.d][b.r].push(b.b); });
    Object.keys(byDk).sort().forEach(dk=>{
      const dd=document.createElement('div'); dd.style.marginBottom='11px';
      dd.innerHTML=`<div style="font-size:10px;color:var(--teal-b);font-weight:700;letter-spacing:1px;text-transform:uppercase;margin-bottom:5px">DECK ${dk}</div>`;
      Object.keys(byDk[dk]).sort((a,b)=>+a-+b).forEach(rm=>{
        const bl=document.createElement('div'); bl.className='room-blk';
        bl.innerHTML=`<div class="room-lbl">Room ${rm}</div><div class="seats"></div>`;
        dd.appendChild(bl);
        const grid=bl.querySelector('.seats');
        [...new Set(byDk[dk][rm])].sort((a,b)=>+a-+b).forEach(bn=>{
          const key=mkKey(cls,dk,rm,bn), pax=berthMap[key];
          const cell=document.createElement('div');
          cell.className='seat'+(pax?' bkd':'');
          cell.title=pax?`${pax.name}\n${pax.ageSex}\nPNR: ${pax.pnr||'â€”'}\nDeboard: ${pax.deboarding}`:`Berth ${bn} â€” free`;
          cell.innerHTML=`<span>${bn}</span><span style="font-size:8px">${pax?'âœ“':''}</span>`;
          cell.addEventListener('click',()=>seatClick(key,cell));
          grid.appendChild(cell);
        });
      });
      el.appendChild(dd);
    });
    const cnt=document.getElementById('cnt-'+cls);
    if(cnt) cnt.textContent=`${PAX.filter(p=>p.classCode===cls).length} boarded`;
  });
}

function seatClick(key,cell){
  const p=berthMap[key]; if(!p) return;
  if(!confirm(`Remove ${p.name} (Berth ${p.bn}) from boarded list?`)) return;
  PAX.splice(PAX.indexOf(p),1); delete berthMap[key];
  cell.classList.remove('bkd'); cell.title=`Berth ${p.bn} â€” free`;
  cell.querySelector('span:last-child').textContent='';
  renderAll();
}

/* â”€â”€ STATS â”€â”€ */
function updStats(){
  let tot=0;
  CLS_ORDER.forEach(c=>{ const n=PAX.filter(p=>p.classCode===c).length; tot+=n;
    const e=document.getElementById('st-'+c); if(e) e.textContent=n; });
  document.getElementById('st0').textContent=tot;
}

/* â”€â”€ PAX TABLE â”€â”€ */
const _debAdded=new Set();
function addDebOpt(port){
  if(!port) return; const n=N(port); if(_debAdded.has(n)) return; _debAdded.add(n);
  const sel=document.getElementById('fdeb');
  if(![...sel.options].find(o=>o.value===n)){ const o=document.createElement('option'); o.value=n; o.textContent=n; sel.appendChild(o); }
}

function renderTbl(){
  const tbody=document.getElementById('pax-body'), empty=document.getElementById('pax-empty');
  const fc=document.getElementById('fcls').value, fd=document.getElementById('fdeb').value;
  const fs=(document.getElementById('fsrch').value||'').toLowerCase();
  tbody.innerHTML='';
  const filt=PAX.filter(p=>{
    if(fc!=='all'&&p.classCode!==fc) return false;
    if(fd!=='all'&&N(p.deboarding)!==fd) return false;
    if(fs&&!p.name.toLowerCase().includes(fs)&&!(p.pnr||'').includes(fs)) return false;
    return true;
  });
  empty.style.display=filt.length?'none':'block';
  filt.forEach((p,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td class="mono" style="color:var(--muted)">${i+1}</td>
      <td class="mono" style="font-size:11px">${p.pnr||'â€”'}</td>
      <td><strong style="color:var(--hi)">${p.name}</strong></td>
      <td>${p.ageSex}</td>
      <td><span class="badge badge-${p.classCode}">${p.classLabel||p.classCode}</span></td>
      <td>${p.dk||'â€”'}</td><td>${p.rm||'â€”'}</td>
      <td class="mono">${p.bn||'â€”'}</td><td>${p.bt||'â€”'}</td>
      <td style="font-size:12px">${p.deboarding||'â€”'}</td>
      <td><button onclick="removePax('${p.key}')"
        style="background:rgba(239,68,68,.13);color:#f87171;border:1px solid rgba(239,68,68,.27);
        border-radius:4px;padding:2px 7px;cursor:pointer;font-size:11px">âœ•</button></td>`;
    tbody.appendChild(tr);
  });
}

function removePax(key){
  const p=berthMap[key]; if(!p||!confirm(`Remove ${p.name}?`)) return;
  PAX.splice(PAX.indexOf(p),1); delete berthMap[key]; renderAll();
}

/* â”€â”€ STATION MAP/TABLE â”€â”€ */
function getStnMap(){
  const sm={};
  PAX.forEach(p=>{ const s=p.deboarding||'UNKNOWN'; if(!sm[s])sm[s]=[]; sm[s].push(p); });
  return sm;
}
function sortedStns(sm){
  const R=cfg.valid||[];
  return Object.keys(sm).sort((a,b)=>{
    const ia=R.indexOf(a),ib=R.indexOf(b);
    if(ia<0&&ib<0) return a.localeCompare(b);
    if(ia<0) return 1; if(ib<0) return -1; return ia-ib;
  });
}

function renderStn(){
  const cards=document.getElementById('stn-cards');
  const dtbl=document.getElementById('stn-tbl');
  const dbody=document.getElementById('stn-body');
  cards.innerHTML=''; dbody.innerHTML='';
  const sm=getStnMap();
  if(!Object.keys(sm).length){
    cards.innerHTML='<div style="font-size:13px;color:var(--muted);padding:10px">No passengers boarded yet</div>';
    dtbl.style.display='none'; return;
  }
  const keys=sortedStns(sm);
  const grid=document.createElement('div'); grid.className='sgrid';
  keys.forEach(st=>{
    const list=sm[st], cc={};
    list.forEach(p=>cc[p.classCode]=(cc[p.classCode]||0)+1);
    const isFin=st===cfg.deboard;
    const card=document.createElement('div'); card.className='sc';
    card.innerHTML=`
      <div class="sc-hdr" style="background:rgba(${isFin?'245,158,11':'14,116,144'},.13)">
        <span style="display:flex;align-items:center;gap:8px">
          <span style="width:9px;height:9px;border-radius:50%;background:${isFin?'var(--amber)':'var(--teal)'};flex-shrink:0;display:inline-block"></span>
          <span style="font-size:13px;color:var(--hi)">${st}</span>
        </span>
        <span class="sc-tot" style="color:${isFin?'var(--amber)':'var(--teal-b)'}">${list.length}</span>
      </div>
      <div class="sc-body">
        ${CLS_ORDER.filter(k=>cc[k]).map(k=>
          `<div class="sc-row"><span style="color:${CLS_CLR[k]}">${CLS_LBL[k]}</span>
           <span class="sc-n" style="color:${CLS_CLR[k]}">${cc[k]}</span></div>`
        ).join('')}
      </div>`;
    grid.appendChild(card);
  });
  cards.appendChild(grid);
  // Detail table
  dtbl.style.display='table';
  keys.forEach(st=>{
    sm[st].forEach((p,i)=>{
      if(i===0){
        const hr=document.createElement('tr');
        hr.innerHTML=`<td colspan="9" style="background:rgba(14,116,144,.13);color:var(--teal-b);font-weight:700;padding:8px;font-size:12px">
          ğŸ“ ${st} â€” ${sm[st].length} passenger(s)</td>`;
        dbody.appendChild(hr);
      }
      const tr=document.createElement('tr');
      tr.innerHTML=`<td style="font-size:11px;color:var(--muted)">${st}</td><td>${i+1}</td>
        <td class="mono" style="font-size:11px">${p.pnr||'â€”'}</td>
        <td><strong>${p.name}</strong></td><td>${p.ageSex}</td>
        <td><span class="badge badge-${p.classCode}">${p.classLabel||p.classCode}</span></td>
        <td>${p.dk||'â€”'}</td><td>${p.rm||'â€”'}</td><td class="mono">${p.bn||'â€”'}</td>`;
      dbody.appendChild(tr);
    });
  });
}

/* â”€â”€ LIVE REPORT â”€â”€ */
function renderRpt(){
  // Class table
  const ct=document.getElementById('rpt-cls'); ct.innerHTML='';
  let tb=0,tt=0;
  CLS_ORDER.forEach(c=>{
    const n=PAX.filter(p=>p.classCode===c).length, tot=(LAY[c]||[]).length; tb+=n; tt+=tot;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${CLS_LBL[c]}</td><td class="mono" style="color:var(--green)">${n}</td>
      <td class="mono">${tot}</td><td class="mono" style="color:${tot-n>0?'var(--amber)':'var(--muted)'}">${tot-n}</td>`;
    ct.appendChild(tr);
  });
  const tf=document.createElement('tr'); tf.className='trow';
  tf.innerHTML=`<td>TOTAL</td><td class="mono">${tb}</td><td class="mono">${tt}</td><td class="mono">${tt-tb}</td>`;
  ct.appendChild(tf);

  // Station table
  const st=document.getElementById('rpt-stn'); st.innerHTML='';
  const sm=getStnMap(), total=PAX.length;
  if(!Object.keys(sm).length){ st.innerHTML='<tr><td colspan="3" style="color:var(--muted);text-align:center;padding:10px">No data yet</td></tr>'; }
  else sortedStns(sm).forEach(s=>{
    const n=sm[s].length;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${s}</td><td class="mono" style="color:var(--teal-b)">${n}</td><td class="mono">${total?(n/total*100).toFixed(1):0}%</td>`;
    st.appendChild(tr);
  });

  // Matrix
  const mt=document.getElementById('rpt-mat'); mt.innerHTML='';
  const stns=sortedStns(sm);
  if(stns.length){
    const hd=document.createElement('thead');
    hd.innerHTML=`<tr><th>Class</th>${stns.map(s=>`<th style="font-size:10px">${s}</th>`).join('')}<th>TOTAL</th></tr>`;
    mt.appendChild(hd);
    const bd=document.createElement('tbody');
    const cTots=stns.map(()=>0); let grand=0;
    CLS_ORDER.forEach(c=>{
      const tr=document.createElement('tr'); let rowT=0;
      const cells=stns.map(s=>{ const n=(sm[s]||[]).filter(p=>p.classCode===c).length; rowT+=n; return n; });
      cells.forEach((n,i)=>cTots[i]+=n); grand+=rowT;
      tr.innerHTML=`<td style="color:${CLS_CLR[c]}">${CLS_LBL[c]}</td>
        ${cells.map(n=>`<td class="mono">${n||'â€”'}</td>`).join('')}
        <td class="mono" style="color:var(--teal-b);font-weight:700">${rowT}</td>`;
      bd.appendChild(tr);
    });
    const ttr=document.createElement('tr'); ttr.className='trow';
    ttr.innerHTML=`<td>TOTAL</td>${cTots.map(n=>`<td class="mono">${n}</td>`).join('')}<td class="mono">${grand}</td>`;
    bd.appendChild(ttr); mt.appendChild(bd);
  } else {
    mt.innerHTML='<tbody><tr><td style="color:var(--muted);text-align:center;padding:12px" colspan="10">No data yet</td></tr></tbody>';
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TABS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const TAB_NAMES=['berth','pax','stn','rpt'];
function goTab(name){
  document.querySelectorAll('.tab').forEach((t,i)=>t.classList.toggle('on',TAB_NAMES[i]===name));
  document.querySelectorAll('.tp').forEach(p=>p.classList.toggle('on',p.id==='tp-'+name));
  if(name==='stn') renderStn();
  if(name==='rpt') renderRpt();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   QR SCANNER  (jsQR + native getUserMedia)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let scanStream=null, scanAnim=null, camFacing='environment';

function toggleScan(){
  const p=document.getElementById('scanpanel');
  p.classList.contains('open') ? stopScan() : startScan();
}

async function startScan(){
  const panel=document.getElementById('scanpanel');
  const st=document.getElementById('scanst');
  const btn=document.getElementById('btnscan');
  panel.classList.add('open');
  btn.textContent='â¹ Stop Scanner'; btn.classList.add('rec');
  st.textContent='Requesting camera accessâ€¦'; st.className='scan-status';

  if(typeof jsQR==='undefined'){
    st.textContent='âŒ QR library not loaded â€” use Manual Entry below';
    st.className='scan-status er';
    toast('w','ğŸ“· QR Library','jsQR failed to load. Use Manual Entry instead.');
    panel.classList.remove('open'); btn.textContent='ğŸ“· Scan QR'; btn.classList.remove('rec');
    return;
  }
  try{
    scanStream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:camFacing, width:{ideal:1280}, height:{ideal:720} }
    });
    const vid=document.getElementById('camvid');
    vid.srcObject=scanStream; await vid.play();
    st.textContent='ğŸ“· Scanningâ€¦ point camera at QR code'; st.className='scan-status ok';
    loopScan();
  }catch(e){
    let msg='Camera error.';
    if(e.name==='NotAllowedError') msg='Camera permission denied. Allow camera access in browser settings.';
    else if(e.name==='NotFoundError') msg='No camera found on this device.';
    else if(e.name==='NotReadableError') msg='Camera is in use by another app.';
    st.textContent='âŒ '+msg; st.className='scan-status er';
    toast('e','ğŸ“· Camera Error',msg+'\n\nUse Manual Entry below instead.');
    panel.classList.remove('open'); btn.textContent='ğŸ“· Scan QR'; btn.classList.remove('rec');
  }
}

let _lastScan=0;
function loopScan(){
  const vid=document.getElementById('camvid');
  const cvs=document.getElementById('camcvs');
  if(!vid||vid.readyState<2){ scanAnim=requestAnimationFrame(loopScan); return; }
  const ctx=cvs.getContext('2d');
  cvs.width=vid.videoWidth; cvs.height=vid.videoHeight;
  ctx.drawImage(vid,0,0,cvs.width,cvs.height);
  const img=ctx.getImageData(0,0,cvs.width,cvs.height);
  const code=jsQR(img.data,img.width,img.height,{inversionAttempts:'dontInvert'});
  if(code){
    const now=Date.now();
    if(now-_lastScan>3000){
      _lastScan=now;
      const st=document.getElementById('scanst');
      st.textContent='âœ… QR detected â€” processingâ€¦'; st.className='scan-status ok';
      let raw=code.data;
      try{ const j=JSON.parse(raw); raw=jsonToText(j); }catch(e2){}
      processTicket(raw);
      setTimeout(()=>{ const s=document.getElementById('scanst'); if(s){ s.textContent='ğŸ“· Ready â€” scan next ticket'; s.className='scan-status ok'; } },2500);
    }
  }
  scanAnim=requestAnimationFrame(loopScan);
}

function stopScan(){
  if(scanAnim){ cancelAnimationFrame(scanAnim); scanAnim=null; }
  if(scanStream){ scanStream.getTracks().forEach(t=>t.stop()); scanStream=null; }
  const vid=document.getElementById('camvid'); if(vid) vid.srcObject=null;
  document.getElementById('scanpanel').classList.remove('open');
  const btn=document.getElementById('btnscan');
  btn.textContent='ğŸ“· Scan QR'; btn.classList.remove('rec');
}

async function flipCam(){
  camFacing=camFacing==='environment'?'user':'environment';
  stopScan(); await new Promise(r=>setTimeout(r,300)); startScan();
}

function jsonToText(j){
  let o='';
  if(j.pnr)        o+=`PNR: ${j.pnr},\n`;
  if(j.txnId)      o+=`Txn ID: ${j.txnId},\n`;
  if(j.vessel)     o+=`Vessel: ${j.vessel},\n`;
  if(j.voyage)     o+=`Voyage: ${j.voyage},\n`;
  if(j.boarding)   o+=`Boarding: ${j.boarding},\n`;
  if(j.deboarding) o+=`Deboarding: ${j.deboarding},\n`;
  if(j.sailingDate)o+=`Sailing Date&Time: ${j.sailingDate} 07:00,\n`;
  if(j.class)      o+=`Class: ${j.class},\n`;
  (j.passengers||(j.name?[j]:[])).forEach((p,i)=>{
    o+=`Passenger ${i+1}: \n\t${p.name}\n\t${p.ageSex||''}\n\t${p.berth||p.berthRaw||''}\n`;
  });
  return o;
}

function procManual(){ processTicket(document.getElementById('manual-inp').value); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toast(type,title,msg){
  const wrap=document.getElementById('twrap');
  const t=document.createElement('div'); t.className='toast '+type;
  t.innerHTML=`<div class="tt">${title}</div><div style="font-size:12px;color:var(--muted);white-space:pre-line">${msg||''}</div>`;
  wrap.appendChild(t);
  setTimeout(()=>{ t.style.cssText='opacity:0;transition:opacity .5s'; setTimeout(()=>t.remove(),520); },5000);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EXPORTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function vLine(){ return `${cfg.vessel||'(Not set)'} | Voyage ${cfg.voyage||'â€”'} | ${cfg.boarding||'â€”'} â†’ ${cfg.deboard||'â€”'} | ${cfg.date||'â€”'} ${cfg.time||''}`; }
function fName(tag){ return `DSS_${(cfg.vessel||'Ship').replace(/\s/g,'_')}_V${cfg.voyage||'0'}_${tag}_${new Date().toISOString().slice(0,10)}`; }
function pdfCredit(doc){ doc.setFontSize(7); doc.setTextColor(100,120,150); const W=doc.internal.pageSize.getWidth(); doc.text('Developed by Mahesh Surada (DSS Staff) | Â© 2025 Mahesh Surada. All Rights Reserved.',W/2,doc.internal.pageSize.getHeight()-5,{align:'center'}); }

function expPDF_full(){
  if(!PAX.length){ toast('w','No Data','No passengers to export'); return; }
  const{jsPDF}=window.jspdf; const doc=new jsPDF('l','mm','a4');
  const W=doc.internal.pageSize.getWidth(), now=new Date().toLocaleString('en-IN');

  doc.setFontSize(18); doc.setTextColor(34,211,238);
  doc.text('DSS â€” BOARDING REPORT',W/2,15,{align:'center'});
  doc.setFontSize(9); doc.setTextColor(160,190,220);
  doc.text(vLine(),W/2,22,{align:'center'});
  doc.text(`Printed: ${now}   |   Total Boarded: ${PAX.length}`,W/2,27,{align:'center'});

  // Class summary (left half)
  doc.setFontSize(10); doc.setTextColor(34,211,238); doc.text('CLASS-WISE SUMMARY',14,36);
  const csR=CLS_ORDER.map(c=>[CLS_LBL[c],PAX.filter(p=>p.classCode===c).length,(LAY[c]||[]).length,(LAY[c]||[]).length-PAX.filter(p=>p.classCode===c).length]);
  csR.push(['TOTAL',PAX.length,'','']);
  doc.autoTable({head:[['Class','Boarded','Berths','Remaining']],body:csR,startY:38,
    styles:{fontSize:9,cellPadding:3},headStyles:{fillColor:[14,116,144]},
    columnStyles:{1:{halign:'center'},2:{halign:'center'},3:{halign:'center'}},
    margin:{left:14,right:W/2+4}});

  // Station summary (right half)
  const sm=getStnMap(), skeys=sortedStns(sm);
  doc.setFontSize(10); doc.setTextColor(34,211,238); doc.text('STATION-WISE SUMMARY',W/2+4,36);
  const stR=skeys.map(s=>[s,sm[s].length,(PAX.length?(sm[s].length/PAX.length*100).toFixed(1):0)+'%']);
  stR.push(['TOTAL',PAX.length,'100%']);
  doc.autoTable({head:[['Deboarding Station','Passengers','%']],body:stR,startY:38,
    styles:{fontSize:9,cellPadding:3},headStyles:{fillColor:[14,116,144]},
    columnStyles:{1:{halign:'center'},2:{halign:'center'}},margin:{left:W/2+4,right:14}});

  // Matrix
  const mY=Math.max(doc.lastAutoTable.finalY,80)+8;
  doc.setFontSize(10); doc.setTextColor(34,211,238); doc.text('CLASS Ã— STATION MATRIX',14,mY);
  const mH=[['Class',...skeys,'TOTAL']];
  const mB=CLS_ORDER.map(c=>{ const row=[CLS_LBL[c]]; let rt=0;
    skeys.forEach(s=>{ const n=(sm[s]||[]).filter(p=>p.classCode===c).length; row.push(n||'â€”'); rt+=n; });
    row.push(rt); return row; });
  mB.push(['TOTAL',...skeys.map(s=>sm[s].length),PAX.length]);
  doc.autoTable({head:mH,body:mB,startY:mY+2,styles:{fontSize:8,cellPadding:2.5,halign:'center'},
    headStyles:{fillColor:[14,116,144]},columnStyles:{0:{halign:'left'}},margin:{left:14,right:14}});
  pdfCredit(doc);

  // Page 2 â€” full passenger list
  doc.addPage('a4','l');
  doc.setFontSize(13); doc.setTextColor(34,211,238); doc.text('COMPLETE PASSENGER LIST',W/2,14,{align:'center'});
  doc.setFontSize(8); doc.setTextColor(160,190,220); doc.text(vLine()+'   |   '+now,W/2,20,{align:'center'});
  doc.autoTable({
    head:[['#','PNR','Name','Age/Sex','Class','Deck','Room','Berth','Type','Deboarding']],
    body:PAX.map((p,i)=>[i+1,p.pnr||'â€”',p.name,p.ageSex,p.classLabel||p.classCode,p.dk||'â€”',p.rm||'â€”',p.bn||'â€”',p.bt||'â€”',p.deboarding||'â€”']),
    startY:24,styles:{fontSize:8,cellPadding:2.5},headStyles:{fillColor:[14,116,144]},
    alternateRowStyles:{fillColor:[18,36,62]},margin:{left:10,right:10}});
  pdfCredit(doc);
  doc.save(fName('FullReport')+'.pdf');
}

function expPDF_stn(){
  if(!PAX.length){ toast('w','No Data','No passengers to export'); return; }
  const{jsPDF}=window.jspdf; const doc=new jsPDF('p','mm','a4');
  const W=doc.internal.pageSize.getWidth(), now=new Date().toLocaleString('en-IN');
  const sm=getStnMap(), keys=sortedStns(sm);

  doc.setFontSize(17); doc.setTextColor(34,211,238); doc.text('STATION-WISE PASSENGER LIST',W/2,22,{align:'center'});
  doc.setFontSize(9); doc.setTextColor(160,190,220);
  doc.text(vLine(),W/2,30,{align:'center'});
  doc.text('Printed: '+now,W/2,36,{align:'center'});
  doc.setFontSize(10); doc.setTextColor(34,211,238); doc.text('ROUTE SUMMARY',14,48);
  const covR=keys.map(s=>[s,sm[s].length,(PAX.length?(sm[s].length/PAX.length*100).toFixed(1):0)+'%']);
  covR.push(['GRAND TOTAL',PAX.length,'100%']);
  doc.autoTable({head:[['Deboarding Station','Passengers','%']],body:covR,startY:50,
    styles:{fontSize:10,cellPadding:4},headStyles:{fillColor:[14,116,144]},margin:{left:14,right:14}});
  pdfCredit(doc);

  keys.forEach(st=>{
    doc.addPage();
    doc.setFontSize(14); doc.setTextColor(34,211,238); doc.text('DEBOARDING: '+st,W/2,16,{align:'center'});
    doc.setFontSize(8); doc.setTextColor(160,190,220);
    doc.text(`${sm[st].length} passenger(s)   |   ${vLine()}`,W/2,22,{align:'center'});
    const cc={}; sm[st].forEach(p=>cc[p.classCode]=(cc[p.classCode]||0)+1);
    const cbR=CLS_ORDER.filter(k=>cc[k]).map(k=>[CLS_LBL[k],cc[k]]);
    doc.autoTable({head:[['Class','Count']],body:cbR,startY:26,
      styles:{fontSize:9,cellPadding:3},headStyles:{fillColor:[10,80,100]},
      margin:{left:14,right:W/2+4},tableWidth:70});
    doc.autoTable({
      head:[['#','PNR','Name','Age/Sex','Class','Deck','Room','Berth','Type']],
      body:sm[st].map((p,i)=>[i+1,p.pnr||'â€”',p.name,p.ageSex,p.classLabel||p.classCode,p.dk||'â€”',p.rm||'â€”',p.bn||'â€”',p.bt||'â€”']),
      startY:26,styles:{fontSize:9,cellPadding:3},headStyles:{fillColor:[14,116,144]},
      alternateRowStyles:{fillColor:[240,248,255]},margin:{left:10,right:10}});
    pdfCredit(doc);
  });
  doc.save(fName('StationList')+'.pdf');
}

function expExcel(){
  if(!PAX.length){ toast('w','No Data','No passengers to export'); return; }
  const wb=XLSX.utils.book_new();
  const allH=[['#','PNR','TxnID','Name','Age/Sex','Class','Deck','Room','Berth','Berth Type','Boarding','Deboarding','Sail Date']];
  PAX.forEach((p,i)=>allH.push([i+1,p.pnr||'',p.txn||'',p.name,p.ageSex,p.classLabel||p.classCode,p.dk||'',p.rm||'',p.bn||'',p.bt||'',p.boarding||'',p.deboarding||'',p.sailDate||'']));
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(allH),'All Passengers');
  const sm=getStnMap();
  sortedStns(sm).forEach(st=>{
    const h=[['#','PNR','Name','Age/Sex','Class','Deck','Room','Berth','Type']];
    sm[st].forEach((p,i)=>h.push([i+1,p.pnr||'',p.name,p.ageSex,p.classLabel||p.classCode,p.dk||'',p.rm||'',p.bn||'',p.bt||'']));
    XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(h),st.slice(0,31));
  });
  const sumH=[['Station','Passengers','%']];
  sortedStns(sm).forEach(s=>sumH.push([s,sm[s].length,(PAX.length?(sm[s].length/PAX.length*100).toFixed(1)+'%':'0%')]));
  sumH.push(['TOTAL',PAX.length,'100%']);
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(sumH),'Station Summary');
  XLSX.writeFile(wb,fName('Boarding')+'.xlsx');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
updHdr();
renderAll();
</script>
</body>
</html>
